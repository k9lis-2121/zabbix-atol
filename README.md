# zabbix-atol
script grabber service info kkm

Это простой скрипт на Python формирующий JSON с данными с кассы и передающий их Заббиксу, состоящий из 98% документированного API Атол.
Я не являюсь не выскоквалифицированным админом, ни программистом, у меня была задача, готовой реализации которой, я не нашел.
Мое решение оказалось востребованным среди тех, кто слышал о нем, поэтому я выкладываю его. Он далеко от совершенства и наверняка требует доработки.
Потенциально в скрипт можно заложить глубокие функции по управлению самой кассой (сейчас кроме сбора реализована перезагрузка).

Я долго тестировал скрипт, и сейчас по мне все работает хорошо, однако не исключено что, какие-то данные отображаются не корректно (например
перепутан рег. номер ккт и рег. номер фн), поэтому проверяйте все чателно и по необходимости вносте правки.

Краткий (не полный перечень) приемуществ которые даст такое отслеживание:
1. Срок действия ФН с 3 триггерами с истичением срока.
2. Ошибки передачи документов (наличие ошибки и расшифровка ошибки).
3. Кол-во не отправленных документов.
4. Возраст первого не отправленного документа.
5. Регистрационные данные (полезно при замене ФН или регистрации новой кассы).
6. Версия прошивки (для поддержания касс в актуальном и едином состоянии).

Принцип работы:
1. Заббикс сервер, обращается к агенту с активной проверкой.
2. Заббикс агент в свою очередь инициализирует запуск скрипта.
3. Скрипт опрашивает кассу и записывает результаты в Json файл.
4. Заббикс сервер с настроенным интервалом опрашивает Json файл записывая все в один элемент данных.
5. Заббикс сервер создает зависимые элементы данных и разбирает полученный Json.
6. Триггеры настроенны на зависимые элементы данных.

!!!ВНИМАНИЕ!!!
При работе скрипт занимает COM-порт! Рекомендуется поместить его в автозагрузку и исполнять до того софта, который будет дальше работать с кассой, 
а в скрипте после сбора данных прописать запуск нудножного в дальнейшем софта.
Таким образом, предпологается использование опроса не чаще 1 раза в сутки.

В настрйоках агента должен быть настроен активный режим.

Протестировано на следующих платформах:
zabbix-server 5.4.9
Zabbix-agent 5.X.X
Windows 7, 10
Python 2.5.X
Драйвер Атол 8.X, 10.X
ККТ Атол 11Ф (возможно будет работать и с другими моделями)

Список используемых модулей:
sys
libfptr10
datetime
time
json
os

Модуль libfptr10 есть в папке с драйвером Атола

Предварительно необходимо создать пустой файл data.json и он должен находится по следующему пути и доступен для перезаписи скриптом:
C:\Program Files\Zabbix Agent\data.json

Параметры для агента:
AllowKey=system.run[*]
AllowKey=system.run[python kktatolmetrics.py ModelKKT]
